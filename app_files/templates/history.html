{% extends 'base.html' %}

{% block title %}RUNR - Promotion History{% endblock %}

{% block content %}
    <div class="container mt-4">
        <div class="page-header">
            <h2>Promotion History</h2>
        </div>
        
        <div id="history-list">
            {% if history %}
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Type</th>
                            <th>Details</th>
                            <th>Status</th>
                            <th>Message</th>
                            <th>Duration</th>
                            <th>Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in history %}
                            {# Ensure entry is a dictionary before accessing #}
                            {% if entry is mapping %}
                                <tr data-job-id="{{ entry.get('job_id') }}">
                                    {# TEMP: Display raw data for debugging #}
                                    {# <td colspan="6">{{ entry | string }}</td> #}
                                    {# OLD TIMESTAMP LOGIC #}
                                    <td>
                                        {# Use get for timestamp too #}
                                        {{ entry.get('start_time') | format_datetime if entry.get('start_time') else entry.get('timestamp', 'N/A') | format_datetime if entry.get('timestamp') else 'N/A' }}
                                    </td>
                                    {# #}
                                    {# OLD TYPE LOGIC #}
                                    <td>
                                        {% set raw_type = entry.get('type', 'Unknown') %}
                                        {% set normalized_type = raw_type | replace(' (api by service)', '') | replace(' (api)', '') | replace(' (API by service)', '') | replace(' (API)', '') %}
                                        {{ normalized_type | capitalize }}
                                    </td>
                                    {# #}
                                    {# DETAILS LOGIC - Extract platform/engagement from profile_name if not directly available #}
                                    <td>
                                        {% set entry_type = entry.get('type') %}
                                        {% set raw_platform = entry.get('platform') %}
                                        {% set raw_engagement = entry.get('engagement') %}
                                        {% set profile_name = entry.get('profile_name', '') %}
                                        {# Parse platform/engagement from profile_name if missing (format: "Platform - Engagement" or "Platform - Engagement - #ServiceId") #}
                                        {% if not raw_platform and profile_name and ' - ' in profile_name %}
                                            {% set parts = profile_name.split(' - ') %}
                                            {% set raw_platform = parts[0] if parts|length > 0 else None %}
                                            {% set raw_engagement = parts[1] if parts|length > 1 else None %}
                                        {% endif %}
                                        {% if entry_type == 'single' or entry_type == 'Single Promo' %}
                                            Platform: {{ raw_platform or 'N/A' }}<br>
                                            Engagement: {{ raw_engagement or 'N/A' }}<br>
                                            {% set link = entry.get('link') %}
                                            Link: {% if link %}<a href="{{ link }}" target="_blank">{{ link[:40] }}{% if link|length > 40 %}...{% endif %}</a>{% else %}N/A{% endif %}<br>
                                            Quantity: {{ entry.get('quantity', 'N/A') }}
                                        {% elif entry_type == 'profile' or entry_type == 'Profile Promo' %}
                                            Profile: {{ profile_name or 'N/A' }}<br>
                                            {% set link = entry.get('link') %}
                                            Link: {% if link %}<a href="{{ link }}" target="_blank">{{ link[:40] }}{% if link|length > 40 %}...{% endif %}</a>{% else %}N/A{% endif %}<br>
                                            Loops/Qty: {{ entry.get('quantity', 'N/A') }}
                                        {% else %} {# Fallback for unknown/older types - also try to show platform/engagement #}
                                            {% if raw_platform %}Platform: {{ raw_platform }}<br>{% endif %}
                                            {% if raw_engagement %}Engagement: {{ raw_engagement }}<br>{% endif %}
                                            {% if not raw_platform and not raw_engagement and profile_name %}{{ profile_name }}<br>{% endif %}
                                            {% set link = entry.get('link') %}
                                            {% if link %} Link: <a href="{{ link }}" target="_blank">{{ link[:40] }}{% if link|length > 40 %}...{% endif %}</a><br>{% endif %}
                                            {% if entry.get('quantity') %} Qty/Loops: {{ entry.get('quantity') }} {% endif %}
                                        {% endif %}
                                        {% set single_provider = entry.get('provider') %}
                                        {% set single_order_id = entry.get('order_id') %}
                                        {% set multiple_orders = entry.get('orders') %}
                                        {% if single_provider and single_order_id %}
                                        <div class="orders-section mt-1">
                                            <div class="order-item" data-provider="{{ single_provider }}" data-order-id="{{ single_order_id }}">
                                                <div><strong>Order:</strong> {{ single_order_id }} <span class="small text-white fw-bold">(
                                                    <a href="{{ single_provider | provider_order_url }}" target="_blank" rel="noopener" class="text-primary text-decoration-underline">{{ single_provider }}</a>
                                                )</span></div>
                                                <div class="order-status-fields small">
                                                    Charge: <span class="order-status-charge">-</span>
                                                    Start: <span class="order-status-start">-</span>
                                                    Status: <span class="order-status-status">-</span>
                                                    Remaining: <span class="order-status-remains">-</span>
                                                    Currency: <span class="order-status-currency">-</span>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {% if multiple_orders %}
                                        <div class="orders-section mt-1">
                                            {% for ord in multiple_orders %}
                                                {% set p = ord.get('provider') %}
                                                {% set oid = ord.get('order_id') %}
                                                {% if p and oid %}
                                                    <div class="order-item" data-provider="{{ p }}" data-order-id="{{ oid }}">
                                                        <div><strong>Order:</strong> {{ oid }} <span class="small text-white fw-bold">(
                                                            <a href="{{ p | provider_order_url }}" target="_blank" rel="noopener" class="text-primary text-decoration-underline">{{ p }}</a>
                                                        )</span></div>
                                                        <div class="order-status-fields small">
                                                            Charge: <span class="order-status-charge">-</span>
                                                            Start: <span class="order-status-start">-</span>
                                                            Status: <span class="order-status-status">-</span>
                                                            Remaining: <span class="order-status-remains">-</span>
                                                            Currency: <span class="order-status-currency">-</span>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    </td>
                                    {# #}
                                    <td class="status-cell">Loading...</td>
                                    {# OLD MESSAGE LOGIC #}
                                    <td class="message-cell">{{ entry.get('message', '') }}</td>
                                    {# #}
                                    {# OLD DURATION LOGIC #}
                                    <td>
                                        {% set duration = entry.get('duration_seconds') %}
                                        {% if duration is not none and duration is number %}
                                            {{ "%.2f"|format(duration) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td class="cost-cell">
                                        {% set tc = entry.get('total_cost') %}
                                        {% if tc is not none %}
                                            ${{ "%.6f"|format(tc) }}
                                        {% elif entry.get('total_cost') is none and entry.get('unit_rate_per_1k') is not none and entry.get('quantity') is not none %}
                                            {# Fallback compute for single entries if present #}
                                            {% set cr = (entry.get('unit_rate_per_1k') * (entry.get('quantity') / 1000.0)) %}
                                            ${{ "%.6f"|format(cr) }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    {# #}
                                </tr>
                            {% else %}
                                <tr><td colspan="6">Error: Invalid history entry format found.</td></tr>
                            {% endif %} {# End of: if entry is mapping #}
                        {% endfor %} {# End of: for entry in history #}
                    </tbody>
                </table>
            {% else %}
                <p>No history entries yet.</p>
            {% endif %}
        </div>
        
        <!-- Pagination Controls -->
        {% if total_pages > 1 %}
        <nav aria-label="History pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                <!-- Previous Button -->
                <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ current_page - 1 }}" {% if current_page == 1 %}tabindex="-1" aria-disabled="true"{% endif %}>Previous</a>
                </li>
                
                <!-- Page Numbers -->
                {% set start_page = [1, current_page - 2] | max %}
                {% set end_page = [total_pages, current_page + 2] | min %}
                
                {% if start_page > 1 %}
                    <li class="page-item"><a class="page-link" href="?page=1">1</a></li>
                    {% if start_page > 2 %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endif %}
                
                {% for page_num in range(start_page, end_page + 1) %}
                    <li class="page-item {% if page_num == current_page %}active{% endif %}">
                        <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                    </li>
                {% endfor %}
                
                {% if end_page < total_pages %}
                    {% if end_page < total_pages - 1 %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                    <li class="page-item"><a class="page-link" href="?page={{ total_pages }}">{{ total_pages }}</a></li>
                {% endif %}
                
                <!-- Next Button -->
                <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ current_page + 1 }}" {% if current_page == total_pages %}tabindex="-1" aria-disabled="true"{% endif %}>Next</a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
{% endblock %} 